apiVersion: batch/v1
kind: Job
metadata:
  name: postgres-restore
  namespace: n8n
spec:
  template:
    spec:
      containers:
      - name: postgres-restore
        image: postgres:15-alpine
        command:
        - /bin/sh
        - -c
        - |
          set -e
          echo "Starting restore at $(date)"
          
          # Find the latest backup file
          LATEST_BACKUP=$(ls -t /backup/n8n-backup-*.sql.gz 2>/dev/null | head -1)
          
          if [ -z "$LATEST_BACKUP" ]; then
            echo "Error: No backup file found in /backup"
            exit 1
          fi
          
          echo "Using backup file: $LATEST_BACKUP"
          
          # Unzip and restore
          gunzip -c ${LATEST_BACKUP} | PGPASSWORD=${POSTGRES_PASSWORD} psql -h ${POSTGRES_HOST} -U ${POSTGRES_USER} -d ${POSTGRES_DB}
          
          echo "Restore completed successfully"
        env:
        - name: POSTGRES_HOST
          value: postgres-service-simple
        - name: POSTGRES_USER
          valueFrom:
            secretKeyRef:
              name: postgres-secret
              key: POSTGRES_USER
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: postgres-secret
              key: POSTGRES_PASSWORD
        - name: POSTGRES_DB
          valueFrom:
            secretKeyRef:
              name: postgres-secret
              key: POSTGRES_DB
        volumeMounts:
        - name: backup-storage
          mountPath: /backup
      volumes:
      - name: backup-storage
        persistentVolumeClaim:
          claimName: postgres-backup-pvc
      restartPolicy: Never
  backoffLimit: 3

